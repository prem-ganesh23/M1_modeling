# M1_modeling
A software package for modeling and analyzing TMS and tDCS -induced E-Fields in human brain models


Developed by Prem Ganesh, Brain Stimulation Mechanisms Lab at McLean Hospital/Harvard Medical School, 2025.

# Overview

This pipeline automates the generation of Electric Field (E-field) models for **Transcranial Magnetic Stimulation (TMS)** and **transcranial Direct Current Stimulation (tDCS)** using SimNIBS.

It is designed to wrap the standard SimNIBS MATLAB tools into a streamlined workflow that handles:

1.  **Dynamic File Location:** Automatically finds `.msh` files and coil models without hardcoding filenames.

2.  **Safety Checks:** Prevents common crashes (missing directories, undefined paths).

3.  **Automated Geometry:** Handles hemisphere-specific rotations and electrode placements automatically.

------------------------------------------------------------------------

# 1. Installation & Requirements

### Software

-   **MATLAB:** R2020b or newer recommended.

-   **SimNIBS:** Version 4.0 or newer (tested with 4.5).

### Head Modeling

At minimum, you must run charm (<https://simnibs.github.io/simnibs/build/html/tutorial/head_meshing.html>) using a T1w MRI image.

For best results, run recon-all from freesurfer before running charm (<https://surfer.nmr.mgh.harvard.edu/fswiki/recon-all>).

### Directory Setup

To ensure the scripts run correctly, organize your project folder (`M1_modeling`) as follows. The pipeline expects a dedicated `functions` folder.

```{=tex}
M1_modeling/
├── efield_model_wrapper.m       # The main script you run
├── functions/                   # Helper functions
│   ├── run_tms_sim.m
│   ├── run_tdcs_sim.m
│   ├── get_eeg_coords.m
│   └── analyze_roi_stats.m
├── m2m_sub/                     # Subject Data (Output from charm)
└── results/                     # Output directory (Auto-created)
```
# 2. How to Use

### Step 1: Configure the Wrapper

Open `efield_model_wrapper.m` in MATLAB. You only need to edit the **User Configuration** section at the top.

#### A. Set Paths

Point the script to your SimNIBS installation and your subject data.

``` MATLAB
% 1. SimNIBS Path (Must point to 'matlab_tools')
simnibs_path = '/Applications/SimNIBS-4.5/matlab_tools';

% 2. Subject Folder (The m2m folder generated by SimNIBS)
m2m_folder   = '/M1_modeling/m2m_01';

% 3. Output Directory
output_dir   = '/M1_modeling';
```

#### B. Choose Experiment Mode

Set the `mode` variable to either `'TMS'` or `'TDCS'`.

``` MATLAB
mode = 'TMS';
```

### Step 2: Set Parameters

Modify the struct fields for your specific experiment.

**For TMS:**

``` MATLAB
tms.target   = 'C3';                     % EEG location
tms.coil     = 'Magstim_70mm_Fig8.ccd';  % Coil name (searched recursively)
tms.angle    = 45;                       % Orientation relative to midline
tms.didt     = 1.147e8;                  % Maximum dI/dt (A/s)
tms.pct      = 50;                       % % MSO
```

-   TMS target must be expressed as an EEG electrode position

-   Coil name can be found in the SimNIBS installation directory under `resources/coil_models`

    -   edit the didt with the maximum dI/dt value reported by Drakaki et. al. 2022 (<https://pubmed.ncbi.nlm.nih.gov/35490970/>)

**For tDCS:**

``` MATLAB
tdcs.current = 2e-3;                     % 2 mA
tdcs.anode   = struct('label', 'C3',  'dims', [50, 50], 'shape', 'rect');
tdcs.cathode = struct('label', 'Fp2', 'dims', [50, 50], 'shape', 'rect');
```

### Step 3: Run

Click **Run** in MATLAB. The script will:

1.  Dynamically locate the mesh file (e.g., `01.msh`).

2.  Recursively find the coil file in the SimNIBS library.

3.  Calculate the optimal orientation.

4.  Run the simulation and save the output to `output_dir/SubjectID/Mode/Target`.

------------------------------------------------------------------------
